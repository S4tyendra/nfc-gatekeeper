<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Bhojan | IIIT Kota Mess Management Portal</title>
    <style>
        :root {
            --gov-blue: #003366;
            --gov-saffron: #FF9933;
            --gov-green: #138808;
            --primary: #0055a5;
            --bg: #f2f7fa;
            --card: #ffffff;
            --text: #212529;
            --border: #b0c4de;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        body {
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Top Accessibility Strip --- */
        .top-gov-bar {
            background: #ffffff;
            border-bottom: 1px solid #ddd;
            height: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 4%;
            font-size: 11px;
            font-weight: bold;
        }

        .top-gov-bar .left {
            display: flex;
            gap: 15px;
        }

        .top-gov-bar a {
            text-decoration: none;
            color: #444;
        }

        /* --- Institution Header --- */
        header {
            background: white;
            padding: 15px 4%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 4px solid var(--gov-blue);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .inst-logo {
            height: 85px;
            width: auto;
        }

        .inst-title {
            border-left: 2px solid #ccc;
            padding-left: 20px;
        }

        .inst-title .hindi {
            font-size: 20px;
            font-weight: 700;
            color: #000;
            display: block;
        }

        .inst-title .english {
            font-size: 18px;
            font-weight: 600;
            color: var(--gov-blue);
            display: block;
        }

        .inst-title .subtitle {
            font-size: 12px;
            color: #d9534f;
            font-style: italic;
            margin-top: 4px;
            font-weight: bold;
        }

        .header-right img {
            height: 50px;
        }

        /* --- Scrolling Ticker --- */
        .ticker-container {
            background: #e9ecef;
            height: 30px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #ccc;
            overflow: hidden;
        }

        .ticker-label {
            background: #d9534f;
            color: white;
            padding: 0 15px;
            height: 100%;
            display: flex;
            align-items: center;
            font-size: 12px;
            font-weight: bold;
            z-index: 2;
        }

        .ticker-text {
            display: inline-block;
            white-space: nowrap;
            animation: marquee 25s linear infinite;
            font-size: 13px;
            color: #333;
        }

        @keyframes marquee {
            0% {
                transform: translateX(100%);
            }

            100% {
                transform: translateX(-100%);
            }
        }

        /* --- Portal Navigation --- */
        nav {
            background: var(--gov-blue);
            padding: 8px 4%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }

        .session-badge {
            background: var(--gov-saffron);
            color: #000;
            padding: 2px 10px;
            font-weight: bold;
            font-size: 12px;
            border-radius: 2px;
        }

        /* --- Main Content --- */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 380px;
            flex: 1;
            gap: 20px;
            padding: 20px 4%;
            overflow: hidden;
        }

        .status-card {
            background: white;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
        }

        .status-card::before {
            content: "AUTHENTICATION GATEWAY";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: #f8fafc;
            padding: 5px 15px;
            font-size: 11px;
            font-weight: bold;
            color: #666;
            border-bottom: 1px solid #eee;
        }

        .status-card.success {
            background: #f0fff4;
            border: 2px solid var(--gov-green);
        }

        .status-card.denied {
            background: #fff5f5;
            border: 2px solid #d9534f;
        }

        .big-avatar {
            width: 180px;
            height: 220px;
            background: #eee;
            border: 4px solid white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            overflow: hidden;
        }

        .big-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .status-msg {
            font-size: 32px;
            font-weight: 900;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .student-name {
            font-size: 26px;
            color: #000;
            font-weight: bold;
        }

        .student-id {
            font-size: 20px;
            color: #555;
            font-family: 'Courier New', Courier, monospace;
        }

        /* --- Right Sidebar Panels --- */
        .panel {
            background: white;
            border: 1px solid var(--border);
            padding: 15px;
            margin-bottom: 15px;
        }

        .panel-title {
            background: #f1f5f9;
            padding: 5px 10px;
            margin: -15px -15px 15px -15px;
            font-size: 13px;
            font-weight: bold;
            color: var(--gov-blue);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
        }

        .input-box {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .btn {
            border: none;
            padding: 10px;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
            font-size: 12px;
        }

        .btn-primary {
            background: var(--gov-blue);
            color: white;
        }

        .btn-success {
            background: var(--gov-green);
            color: white;
        }

        /* --- Footer --- */
        footer {
            background: #222;
            color: #ccc;
            padding: 10px 4%;
            font-size: 11px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* --- Admin Modal --- */
        .admin-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            place-items: center;
            z-index: 1000;
        }

        .admin-content {
            background: white;
            width: 900px;
            max-width: 95vw;
        }

        .admin-header {
            background: var(--gov-blue);
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
        }
    </style>
</head>

<body>
    <div class="top-gov-bar">
        <div class="left">
            <span>‡§≠‡§æ‡§∞‡§§ ‡§∏‡§∞‡§ï‡§æ‡§∞ | Government of India</span>
            <span>‡§∂‡§ø‡§ï‡•ç‡§∑‡§æ ‡§Æ‡§Ç‡§§‡•ç‡§∞‡§æ‡§≤‡§Ø | Ministry of Education</span>
        </div>
        <div class="right">
            <a href="#" onclick="setLang('hi')">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</a> |
            <a href="#" onclick="setLang('en')">English</a>
        </div>
    </div>

    <header>
        <div class="header-left">
            <img src="iiitkota.png" alt="IIIT Kota Logo" class="inst-logo">
            <div class="inst-title">
                <span class="hindi">‡§≠‡§æ‡§∞‡§§‡•Ä‡§Ø ‡§∏‡•Ç‡§ö‡§®‡§æ ‡§™‡•ç‡§∞‡•å‡§¶‡•ç‡§Ø‡•ã‡§ó‡§ø‡§ï‡•Ä ‡§∏‡§Ç‡§∏‡•ç‡§•‡§æ‡§® ‡§ï‡•ã‡§ü‡§æ</span>
                <span class="english">Indian Institute of Information Technology Kota</span>
                <span class="subtitle">An Institute of National Importance under an Act of Parliament</span>
            </div>
        </div>
        <div class="header-right">
            <img src="https://upload.wikimedia.org/wikipedia/en/thumb/9/95/Digital_India_logo.svg/1200px-Digital_India_logo.svg.png"
                alt="Digital India">
        </div>
    </header>

    <nav>
        <div>
            <span data-t="session_info">Current Mess Session:</span>
            <span class="session-badge" id="sessionTag">Loading...</span>
        </div>
        <div>
            <button class="btn btn-primary" style="background:#444; border:1px solid #666;" onclick="toggleAdmin()"
                data-t="btn_admin">ADMIN</button>
        </div>
    </nav>

    <div class="main-layout">
        <div class="scan-container">
            <div class="status-card" id="mainCard">
                <div class="status-msg" id="statusText" data-t="status_ready">System Ready</div>
                <div class="big-avatar" id="heroImg">üë§</div>
                <div class="student-name" id="heroName" data-t="msg_wait">Please Present Card</div>
                <div class="student-id" id="heroId"></div>
            </div>
        </div>

        <div class="tools-sidebar">
            <div class="panel">
                <div class="panel-title" data-t="manual_title">Manual Authorization</div>
                <div style="display:flex; gap:5px;">
                    <select id="manYear" class="input-box"></select>
                    <select id="manDept" class="input-box">
                        <option value="KUCP">CSE</option>
                        <option value="KUEC">ECE</option>
                    </select>
                </div>
                <input type="text" id="manRoll" class="input-box" placeholder="Enter Roll Number">
                <button class="btn btn-success" style="width:100%" onclick="manualEntry()" data-t="btn_enter">Grant
                    Access</button>
            </div>

            <div class="panel">
                <div class="panel-title">
                    <span>Attendance Log</span>
                    <span id="entryCount" style="color:var(--gov-green)">0</span>
                </div>
                <div id="recentList" style="max-height: 300px; overflow-y: auto; font-size: 12px;">
                    <div style="padding:10px; color:#999; text-align:center;">No data in current session</div>
                </div>
            </div>

            <div style="font-size:10px; color:#666; padding:0 5px;">
                <p id="debugTime"></p>
            </div>
        </div>
    </div>

    <div class="admin-modal" id="adminModal">
        <div class="admin-content">
            <div class="admin-header">
                <h3 data-t="admin_export_title">Mess Administration Dashboard</h3>
                <button class="btn btn-primary" onclick="toggleAdmin()">CLOSE [X]</button>
            </div>
            <div style="padding: 20px;">
                <div
                    style="display:flex; gap:10px; margin-bottom: 20px; background: #f1f1f1; padding:15px; border:1px solid #ccc;">
                    <div style="flex:1">
                        <label style="font-size:11px; font-weight:bold;">REPORTING MONTH</label>
                        <input type="month" id="adminMonth" class="input-box" onchange="loadAdminData()">
                    </div>
                    <div style="display:flex; align-items:flex-end; padding-bottom:8px;">
                        <button class="btn btn-primary" onclick="downloadCSV()">Generate CSV Report</button>
                    </div>
                </div>

                <div style="display:grid; grid-template-columns: 1fr 2fr; gap:15px; margin-bottom: 20px;">
                    <div style="border:1px solid #ccc; padding:15px; text-align:center;">
                        <div style="font-size:11px; color:#666;">MONTHLY TOTAL</div>
                        <div style="font-size:36px; font-weight:bold; color:var(--gov-blue);" id="statTotal">0</div>
                    </div>
                    <div style="border:1px solid #ccc; padding:10px;">
                        <div id="statSessions" style="font-size:12px; line-height:1.6;"></div>
                    </div>
                </div>

                <div style="height: 250px; overflow-y: auto; border:1px solid #ccc;">
                    <table style="width:100%; text-align:left; border-collapse: collapse; font-size:12px;">
                        <thead style="background:#eee; position:sticky; top:0;">
                            <tr>
                                <th style="padding:8px; border:1px solid #ccc;">Date</th>
                                <th style="padding:8px; border:1px solid #ccc;">Breakfast</th>
                                <th style="padding:8px; border:1px solid #ccc;">Lunch</th>
                                <th style="padding:8px; border:1px solid #ccc;">Snacks</th>
                                <th style="padding:8px; border:1px solid #ccc;">Dinner</th>
                            </tr>
                        </thead>
                        <tbody id="statTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <div>Portal Last Updated: 21 Oct 2023 | Site designed by Satyendra, IIIT Kota</div>
        <div>Best viewed in Google Chrome (Version 108+)</div>
    </footer>

    <script>
        const API_BASE = window.location.origin;
        const WS_URL = `ws://${window.location.host}/ws`;

        const TEXTS = {
            en: {
                app_title: "E-Bhojan Portal",
                btn_admin: "Admin Login",
                status_ready: "System Ready",
                msg_wait: "Please Present Card",
                manual_title: "Manual Authorization",
                btn_enter: "Grant Access",
                session_info: "Current Mess Session:",
                admin_export_title: "Mess Administration Dashboard",
                allowed: "ACCESS GRANTED",
                denied: "ACCESS DENIED",
                error: "ERROR"
            },
            hi: {
                app_title: "‡§à-‡§≠‡•ã‡§ú‡§® ‡§™‡•ã‡§∞‡•ç‡§ü‡§≤",
                btn_admin: "‡§™‡•ç‡§∞‡§∂‡§æ‡§∏‡§ï ‡§≤‡•â‡§ó‡§ø‡§®",
                status_ready: "‡§∏‡§ø‡§∏‡•ç‡§ü‡§Æ ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§π‡•à",
                msg_wait: "‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡§æ‡§∞‡•ç‡§° ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç",
                manual_title: "‡§Æ‡•à‡§®‡•Å‡§Ö‡§≤ ‡§™‡•ç‡§∞‡§æ‡§ß‡§ø‡§ï‡§∞‡§£",
                btn_enter: "‡§™‡•ç‡§∞‡§µ‡•á‡§∂ ‡§¶‡•á‡§Ç",
                session_info: "‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§Æ‡•á‡§∏ ‡§∏‡§§‡•ç‡§∞:",
                admin_export_title: "‡§Æ‡•á‡§∏ ‡§™‡•ç‡§∞‡§∂‡§æ‡§∏‡§® ‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§°",
                allowed: "‡§™‡•ç‡§∞‡§µ‡•á‡§∂ ‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§",
                denied: "‡§™‡•ç‡§∞‡§µ‡•á‡§∂ ‡§µ‡§∞‡•ç‡§ú‡§ø‡§§",
                error: "‡§§‡•ç‡§∞‡•Å‡§ü‡§ø"
            }
        };

        let curLang = 'en';

        function setLang(l) {
            curLang = l;
            document.querySelectorAll('[data-t]').forEach(el => {
                const k = el.getAttribute('data-t');
                if (TEXTS[l][k]) el.textContent = TEXTS[l][k];
            });
            resetCard();
        }

        const curYear = new Date().getFullYear();
        const sel = document.getElementById('manYear');
        for (let i = curYear; i >= 2020; i--) sel.add(new Option(i, i));

        const ws = new WebSocket(WS_URL);
        ws.onmessage = (e) => {
            const data = JSON.parse(e.data);
            if (data.type === 'mess_response') {
                handleResponse(data);
                if (data.status === 'success') loadRecentEntries();
            }
        };

        function handleResponse(data) {
            const card = document.getElementById('mainCard');
            const txt = document.getElementById('statusText');
            const name = document.getElementById('heroName');
            const id = document.getElementById('heroId');
            const img = document.getElementById('heroImg');

            name.textContent = data.name;
            id.textContent = data.student_id;
            img.innerHTML = data.image_path ? `<img src="${data.image_path}">` : 'üë§';

            card.className = 'status-card';
            if (data.status === 'success') {
                card.classList.add('success');
                txt.textContent = TEXTS[curLang].allowed;
            } else {
                card.classList.add('denied');
                txt.textContent = TEXTS[curLang].denied;
            }
            setTimeout(() => { if (name.textContent === data.name) resetCard(); }, 3000);
        }

        function resetCard() {
            document.getElementById('mainCard').className = 'status-card';
            document.getElementById('statusText').textContent = TEXTS[curLang].status_ready;
            document.getElementById('heroName').textContent = TEXTS[curLang].msg_wait;
            document.getElementById('heroId').textContent = "";
            document.getElementById('heroImg').innerHTML = "üë§";
        }

        async function manualEntry() {
            const roll = document.getElementById('manRoll').value;
            if (!roll) return;
            await fetch(`${API_BASE}/api/entry/manual`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    year: document.getElementById('manYear').value,
                    department: document.getElementById('manDept').value,
                    roll_number: roll,
                    direction: 'in'
                })
            });
            document.getElementById('manRoll').value = '';
        }

        function toggleAdmin() {
            const m = document.getElementById('adminModal');
            m.style.display = (m.style.display !== 'grid') ? 'grid' : 'none';
            if (m.style.display === 'grid') loadAdminData();
        }

        async function loadAdminData() {
            const month = document.getElementById('adminMonth').value || new Date().toISOString().slice(0, 7);
            document.getElementById('adminMonth').value = month;
            try {
                const res = await fetch(`/api/mess/stats?month=${month}`);
                const data = await res.json();
                document.getElementById('statTotal').textContent = data.monthly_total;
                let sHtml = '';
                for (const [k, v] of Object.entries(data.session_totals)) {
                    sHtml += `<div><b>${k}:</b> ${v}</div>`;
                }
                document.getElementById('statSessions').innerHTML = sHtml;
                const tbody = document.getElementById('statTableBody');
                tbody.innerHTML = '';
                Object.keys(data.daily_counts).sort().reverse().forEach(d => {
                    const c = data.daily_counts[d];
                    tbody.innerHTML += `<tr><td style="padding:8px; border:1px solid #ccc;">${d}</td><td style="padding:8px; border:1px solid #ccc;">${c['BREAKFAST'] || 0}</td><td style="padding:8px; border:1px solid #ccc;">${c['LUNCH'] || 0}</td><td style="padding:8px; border:1px solid #ccc;">${c['SNACKS'] || 0}</td><td style="padding:8px; border:1px solid #ccc;">${c['DINNER'] || 0}</td></tr>`;
                });
            } catch (e) { }
        }

        function downloadCSV() {
            window.location.href = `/api/mess/export?month=${document.getElementById('adminMonth').value}`;
        }

        async function loadRecentEntries() {
            try {
                const res = await fetch('/api/mess/recent');
                const entries = await res.json();
                document.getElementById('entryCount').textContent = entries.length;
                let html = '';
                entries.forEach(e => {
                    const time = new Date(e.timestamp).toLocaleTimeString();
                    html += `<div style="padding:5px; border-bottom:1px solid #eee"><b>${time}</b> - ${e.name}</div>`;
                });
                document.getElementById('recentList').innerHTML = html || "No entries";
            } catch (e) { }
        }

        async function updateSession() {
            try {
                const res = await fetch('/api/mess/session');
                const data = await res.json();
                document.getElementById('sessionTag').textContent = data.current_session || "CLOSED";
                document.getElementById('debugTime').textContent = `Server Time: ${new Date().toLocaleString()}`;
            } catch (e) { }
        }
        setInterval(updateSession, 5000);
        setInterval(loadRecentEntries, 10000);
        updateSession();
        loadRecentEntries();
    </script>
</body>

</html>