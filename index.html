<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Gate Portal | Security Management System</title>
    <style>
        :root {
            --gov-blue: #003366;
            --gov-saffron: #FF9933;
            --gov-green: #138808;
            --primary: #0055a5;
            --bg: #f2f7fa;
            --card: #ffffff;
            --text: #212529;
            --border: #ced4da;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
        }

        body {
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- GOI Accessibility Bar --- */
        .top-bar {
            background: #ffffff;
            border-bottom: 1px solid #ddd;
            height: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2%;
            font-size: 11px;
            font-weight: 600;
        }

        .top-bar a {
            text-decoration: none;
            color: #444;
            margin-left: 15px;
            cursor: pointer;
        }

        /* --- Main Official Header --- */
        header {
            background: white;
            padding: 15px 4%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 4px solid var(--gov-blue);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .inst-logo {
            height: 45px;
            width: auto;
        }

        .inst-title {
            border-left: 2px solid #ccc;
            padding-left: 20px;
        }

        .inst-title .hindi {
            font-size: 14px;
            font-weight: 700;
            color: #000;
            display: block;
        }

        .inst-title .english {
            font-size: 16px;
            font-weight: 600;
            color: var(--gov-blue);
            display: block;
        }

        .inst-title .subtitle {
            font-size: 14px;
            color: #d9534f;
            font-style: italic;
            margin-top: 4px;
            font-weight: bold;
        }

        .header-right img {
            height: 50px;
        }


        /* --- Layout --- */
        .container {
            display: grid;
            grid-template-columns: 340px 1fr 340px;
            gap: 15px;
            padding: 15px;
            height: calc(100vh - 120px);
        }

        /* --- Side Panels (The Registers) --- */
        .side-panel {
            background: var(--card);
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .panel-header {
            padding: 12px;
            background: var(--gov-blue);
            color: white;
            border-bottom: 2px solid var(--gov-saffron);
        }

        .panel-title {
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .panel-subtitle {
            font-size: 11px;
            opacity: 0.8;
        }

        .list-scroller {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
            background: #fdfdfd;
        }

        .person-card {
            display: flex;
            align-items: center;
            padding: 8px;
            margin-bottom: 6px;
            background: #fff;
            border: 1px solid #eee;
            border-left: 4px solid var(--gov-blue);
        }

        .avatar-small {
            width: 40px;
            height: 40px;
            background: #f0f0f0;
            border: 1px solid #ddd;
            margin-right: 10px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .avatar-small img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .person-info h4 {
            font-size: 13px;
            color: var(--gov-blue);
        }

        .person-info p {
            font-size: 11px;
            color: #666;
            font-family: monospace;
        }

        /* --- Center (Authentication Area) --- */
        .center-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .scan-area {
            flex: 1;
            background: white;
            border: 1px solid var(--border);
            border-top: 6px solid var(--gov-blue);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
        }

        .scan-area.status-in {
            border-top-color: var(--gov-green);
            background: #f8fff9;
        }

        .scan-area.status-out {
            border-top-color: var(--gov-saffron);
            background: #fffbf5;
        }

        .status-text {
            font-size: 24px;
            font-weight: 800;
            color: var(--gov-blue);
            margin-bottom: 20px;
            text-transform: uppercase;
            border-bottom: 2px solid #eee;
            padding-bottom: 5px;
        }

        .big-avatar {
            width: 200px;
            height: 200px;
            border: 4px solid white;
            box-shadow: 0 0 0 1px #ddd;
            background: #fafafa;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 80px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .big-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .hero-name {
            font-size: 22px;
            font-weight: 700;
            color: #333;
        }

        .hero-id {
            font-size: 18px;
            color: #666;
            font-family: monospace;
            margin-top: 4px;
        }

        .time-pill {
            margin-top: 15px;
            background: #333;
            color: white;
            padding: 4px 15px;
            font-size: 12px;
            font-family: monospace;
        }

        /* --- Manual Entry Form --- */
        .manual-box {
            background: #fff;
            padding: 15px;
            border: 1px solid var(--border);
            border-left: 5px solid var(--gov-saffron);
        }

        .manual-title {
            font-size: 12px;
            font-weight: 800;
            color: var(--gov-blue);
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .form-row {
            display: flex;
            gap: 8px;
        }

        .big-input {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 2px;
            font-size: 14px;
            outline: none;
        }

        .big-input:focus {
            border-color: var(--gov-blue);
            box-shadow: 0 0 3px rgba(0, 51, 102, 0.3);
        }

        .action-btn {
            border: none;
            padding: 0 20px;
            font-weight: 700;
            font-size: 13px;
            cursor: pointer;
            color: white;
            text-transform: uppercase;
        }

        .btn-green {
            background: var(--gov-green);
        }

        .btn-orange {
            background: var(--gov-saffron);
        }

        /* --- Footer --- */
        footer {
            background: #eeeeee;
            border-top: 1px solid #ddd;
            padding: 8px 2%;
            font-size: 11px;
            text-align: center;
            color: #666;
        }

        /* Technician Settings */
        .tech-trigger {
            position: fixed;
            bottom: 40px;
            right: 10px;
            opacity: 0.3;
            cursor: pointer;
        }

        .settings-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border: 1px solid #000;
            z-index: 100;
            width: 320px;
        }

        .settings-modal.show {
            display: block;
        }

        .backdrop {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 99;
        }

        .backdrop.show {
            display: block;
        }
    </style>
</head>

<body>

    <div class="top-bar">
        <div>‡§≠‡§æ‡§∞‡§§ ‡§∏‡§∞‡§ï‡§æ‡§∞ | GOVERNMENT OF INDIA</div>
        <div>
            <a onclick="setLanguage('en')">English</a> |
            <a onclick="setLanguage('hi')">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</a>
        </div>
    </div>


    <header>
        <div class="header-left">
            <img src="iiitkota.png" alt="IIIT Kota Logo" class="inst-logo">
            <div class="inst-title">
                <span class="hindi">‡§≠‡§æ‡§∞‡§§‡•Ä‡§Ø ‡§∏‡•Ç‡§ö‡§®‡§æ ‡§™‡•ç‡§∞‡•å‡§¶‡•ç‡§Ø‡•ã‡§ó‡§ø‡§ï‡•Ä ‡§∏‡§Ç‡§∏‡•ç‡§•‡§æ‡§® ‡§ï‡•ã‡§ü‡§æ</span>
                <span class="english">Indian Institute of Information Technology Kota</span>
                <span class="subtitle">An Institute of National Importance under an Act of Parliament</span>
            </div>
        </div>
        <div class="header-right">
            <img src="https://upload.wikimedia.org/wikipedia/en/thumb/9/95/Digital_India_logo.svg/1200px-Digital_India_logo.svg.png"
                alt="Digital India">
        </div>
    </header>

    <div class="container">

        <!-- Left: IN -->
        <div class="side-panel">
            <div class="panel-header">
                <span class="panel-title" data-translate="list_in_title">Entry Log (‡§Ö‡§Ç‡§¶‡§∞)</span>
                <span class="panel-subtitle" data-translate="list_in_desc">Real-time entry verification list</span>
            </div>
            <div class="list-scroller" id="inList"></div>
        </div>

        <!-- Center: Hero Area -->
        <div class="center-panel">
            <div class="scan-area" id="mainCard">
                <div class="status-text" id="heroStatus" data-translate="status_wait">Ready for Authentication</div>
                <div class="big-avatar" id="heroImg">üë§</div>
                <div class="hero-name" id="heroName">---</div>
                <div class="hero-id" id="heroID">---</div>
                <div class="time-pill" id="heroTime">--:--:--</div>
            </div>

            <!-- Manual Entry Section -->
            <div class="manual-box">
                <div class="manual-title" data-translate="manual_title">Manual Authentication Form (Form 12-A)</div>
                <div class="form-row">
                    <select id="manYear" class="big-input" style="flex:0.5"></select>
                    <select id="manDept" class="big-input" style="flex:0.6">
                        <option value="KUCP">KUCP</option>
                        <option value="KUEC">KUEC</option>
                        <option value="KUAD">KUAD</option>
                    </select>
                    <input type="tel" id="manRoll" class="big-input" placeholder="Roll No" maxlength="4">
                    <button class="action-btn btn-green" onclick="manualEntry('in')" data-translate="btn_in">Log
                        IN</button>
                    <button class="action-btn btn-orange" onclick="manualEntry('out')" data-translate="btn_out">Log
                        OUT</button>
                </div>
            </div>
        </div>

        <!-- Right: OUT -->
        <div class="side-panel">
            <div class="panel-header" style="background: #444;">
                <span class="panel-title" data-translate="list_out_title">Exit Log (‡§¨‡§æ‡§π‡§∞)</span>
                <span class="panel-subtitle" data-translate="list_out_desc">Real-time exit verification list</span>
            </div>
            <div class="list-scroller" id="outList"></div>
        </div>
    </div>

    <footer>
        This portal is designed, developed by Satyendra, IIIT Kota. <br>
    </footer>

    <!-- Technician Settings -->
    <div class="tech-trigger" onclick="toggleSettings()">‚öôÔ∏è Admin Config</div>
    <div class="backdrop" id="modalBackdrop" onclick="toggleSettings()"></div>
    <div class="settings-modal" id="settingsModal">
        <h4 style="margin-bottom:10px; border-bottom:1px solid #ddd">System Configuration</h4>
        <div style="margin-bottom:10px;">
            <label style="font-size:11px; font-weight:bold;">IN Reader</label>
            <select id="inReaderSelect" class="big-input" style="width:100%"
                onchange="handleReaderChange('in')"></select>
        </div>
        <div style="margin-bottom:10px;">
            <label style="font-size:11px; font-weight:bold;">OUT Reader</label>
            <select id="outReaderSelect" class="big-input" style="width:100%"
                onchange="handleReaderChange('out')"></select>
        </div>
        <div style="font-size:11px; color:#666;" id="wsStatusText">Disconnected</div>
    </div>

    <!-- START OF ORIGINAL JAVASCRIPT -->
    <script>
        /* --- Configuration --- */
        const API_BASE = window.location.origin;
        const WS_URL = `ws://${window.location.host}/ws`;

        /* --- Language Dictionary --- */
        const TRANSLATIONS = {
            en: {
                app_title: "E-Gate Entry Management System",
                list_in_title: "Entry Log (‡§Ö‡§Ç‡§¶‡§∞)",
                list_in_desc: "Real-time entry verification list",
                list_out_title: "Exit Log (‡§¨‡§æ‡§π‡§∞)",
                list_out_desc: "Real-time exit verification list",
                status_wait: "Ready for Authentication",
                status_in: "Authorized: ENTRY",
                status_out: "Authorized: EXIT",
                manual_title: "Manual Authentication Form (Form 12-A)",
                btn_in: "Log IN",
                btn_out: "Log OUT",
                unknown: "Unknown Beneficiary"
            },
            hi: {
                app_title: "‡§à-‡§ó‡•á‡§ü ‡§™‡•ç‡§∞‡§µ‡•á‡§∂ ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§® ‡§™‡•ç‡§∞‡§£‡§æ‡§≤‡•Ä",
                list_in_title: "‡§™‡•ç‡§∞‡§µ‡•á‡§∂ ‡§≤‡•â‡§ó (Entry)",
                list_in_desc: "‡§õ‡§æ‡§§‡•ç‡§∞‡•ã‡§Ç ‡§ï‡•á ‡§™‡•ç‡§∞‡§µ‡•á‡§∂ ‡§ï‡•Ä ‡§µ‡§æ‡§∏‡•ç‡§§‡§µ‡§ø‡§ï ‡§∏‡§Æ‡§Ø ‡§∏‡•Ç‡§ö‡•Ä",
                list_out_title: "‡§®‡§ø‡§ï‡§æ‡§∏ ‡§≤‡•â‡§ó (Exit)",
                list_out_desc: "‡§õ‡§æ‡§§‡•ç‡§∞‡•ã‡§Ç ‡§ï‡•á ‡§®‡§ø‡§ï‡§æ‡§∏ ‡§ï‡•Ä ‡§µ‡§æ‡§∏‡•ç‡§§‡§µ‡§ø‡§ï ‡§∏‡§Æ‡§Ø ‡§∏‡•Ç‡§ö‡•Ä",
                status_wait: "‡§™‡•ç‡§∞‡§Æ‡§æ‡§£‡•Ä‡§ï‡§∞‡§£ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§§‡•à‡§Ø‡§æ‡§∞",
                status_in: "‡§™‡•ç‡§∞‡§µ‡•á‡§∂ ‡§Ö‡§ß‡§ø‡§ï‡•É‡§§: IN",
                status_out: "‡§®‡§ø‡§ï‡§æ‡§∏ ‡§Ö‡§ß‡§ø‡§ï‡•É‡§§: OUT",
                manual_title: "‡§Æ‡•à‡§®‡•Å‡§Ö‡§≤ ‡§™‡•ç‡§∞‡§Æ‡§æ‡§£‡•Ä‡§ï‡§∞‡§£ ‡§´‡•â‡§∞‡•ç‡§Æ (‡§™‡•ç‡§∞‡§™‡§§‡•ç‡§∞ 12-‡§è)",
                btn_in: "‡§™‡•ç‡§∞‡§µ‡•á‡§∂ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç",
                btn_out: "‡§®‡§ø‡§ï‡§æ‡§∏ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç",
                unknown: "‡§Ö‡§ú‡•ç‡§û‡§æ‡§§ ‡§≤‡§æ‡§≠‡§æ‡§∞‡•ç‡§•‡•Ä"
            }
        };

        let currentLang = 'en';

        document.addEventListener('DOMContentLoaded', () => {
            const savedLang = localStorage.getItem('gate_lang');
            if (savedLang) setLanguage(savedLang);
            else setLanguage('en');
            loadYearRange();
            connectWebSocket();
            loadRecentData();
            loadReaders();
        });

        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('gate_lang', lang);
            document.querySelectorAll('[data-translate]').forEach(el => {
                const key = el.getAttribute('data-translate');
                if (TRANSLATIONS[lang][key]) el.textContent = TRANSLATIONS[lang][key];
            });
            const hero = document.getElementById('mainCard');
            if (!hero.classList.contains('status-in') && !hero.classList.contains('status-out')) {
                document.getElementById('heroStatus').textContent = TRANSLATIONS[lang].status_wait;
            }
        }

        function connectWebSocket() {
            const ws = new WebSocket(WS_URL);
            const statusTxt = document.getElementById('wsStatusText');
            ws.onopen = () => { statusTxt.textContent = "System Status: Online ‚úÖ"; statusTxt.style.color = "green"; };
            ws.onclose = () => { statusTxt.textContent = "Status: Reconnecting..."; statusTxt.style.color = "red"; setTimeout(connectWebSocket, 3000); };
            ws.onmessage = (e) => {
                const data = JSON.parse(e.data);
                if (data.type === 'tap') handleTap(data);
            };
        }

        function handleTap(data) {
            updateHero(data);
            addToList(data.direction, data);
        }

        function updateHero(data) {
            const card = document.getElementById('mainCard');
            const img = document.getElementById('heroImg');
            const status = document.getElementById('heroStatus');
            const name = document.getElementById('heroName');
            const idField = document.getElementById('heroID');
            const time = document.getElementById('heroTime');

            card.className = 'scan-area';
            void card.offsetWidth;
            img.innerHTML = data.image_path ? `<img src="${data.image_path}" onerror="this.parentElement.innerHTML='üë§'">` : 'üë§';
            name.textContent = data.name || TRANSLATIONS[currentLang].unknown;
            idField.textContent = data.student_id || "";
            time.textContent = new Date().toLocaleTimeString();

            if (data.direction === 'in') {
                card.classList.add('status-in');
                status.textContent = TRANSLATIONS[currentLang].status_in;
            } else {
                card.classList.add('status-out');
                status.textContent = TRANSLATIONS[currentLang].status_out;
            }
            // speak(name.textContent + ". " + status.textContent);
        }

        function addToList(direction, data) {
            const listId = direction === 'in' ? 'inList' : 'outList';
            const container = document.getElementById(listId);
            const imgHtml = data.image_path ? `<div class="avatar-small"><img src="${data.image_path}" onerror="this.parentElement.innerHTML='üë§'"></div>` : '<div class="avatar-small">üë§</div>';
            const html = `<div class="person-card">${imgHtml}<div class="person-info"><h4>${data.name || 'Unknown'}</h4><p>${data.student_id} ‚Ä¢ ${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</p></div></div>`;
            container.insertAdjacentHTML('afterbegin', html);
            if (container.children.length > 20) container.lastElementChild.remove();
        }

        async function loadRecentData() {
            try {
                ['in', 'out'].forEach(async dir => {
                    const res = await fetch(`/api/entries/recent?direction=${dir}&limit=10`);
                    const json = await res.json();
                    const container = document.getElementById(dir === 'in' ? 'inList' : 'outList');
                    container.innerHTML = '';
                    if (json.entries) json.entries.forEach(e => addToList(dir, e));
                });
            } catch (e) { }
        }

        async function loadYearRange() {
            const yearSelect = document.getElementById('manYear');
            const curYear = new Date().getFullYear();
            for (let i = curYear; i >= 2020; i--) yearSelect.add(new Option(i, i));
        }

        async function manualEntry(direction) {
            const roll = document.getElementById('manRoll').value;
            if (!roll) return alert(currentLang === 'hi' ? "‡§ï‡•É‡§™‡§Ø‡§æ ‡§∞‡•ã‡§≤ ‡§®‡§Ç‡§¨‡§∞ ‡§≠‡§∞‡•á‡§Ç" : "Please enter Roll Number");
            const payload = { year: document.getElementById('manYear').value, department: document.getElementById('manDept').value, roll_number: roll, direction: direction };
            try {
                const res = await fetch(`/api/entry/manual`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (res.status === 404) alert("Data not found");
                else document.getElementById('manRoll').value = "";
            } catch (e) { alert("Error"); }
        }

        function toggleSettings() {
            document.getElementById('settingsModal').classList.toggle('show');
            document.getElementById('modalBackdrop').classList.toggle('show');
        }

        async function loadReaders() {
            try {
                const rRes = await fetch(`/api/readers`);
                const rData = await rRes.json();
                const cRes = await fetch(`/api/readers/config`);
                const cData = await cRes.json();
                const inSel = document.getElementById('inReaderSelect');
                const outSel = document.getElementById('outReaderSelect');
                [inSel, outSel].forEach(s => {
                    s.innerHTML = '<option value="">-- Select --</option>';
                    rData.readers.forEach(r => s.add(new Option(r.name, r.name)));
                });
                if (cData.in_reader) inSel.value = cData.in_reader;
                if (cData.out_reader) outSel.value = cData.out_reader;
            } catch (e) { }
        }

        function handleReaderChange() {
            const inR = document.getElementById('inReaderSelect').value;
            const outR = document.getElementById('outReaderSelect').value;
            fetch(`/api/readers/config`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ in_reader: inR, out_reader: outR }) });
        }

        // function speak(text) {
        //     if ('speechSynthesis' in window) {
        //         const u = new SpeechSynthesisUtterance(text);
        //         u.lang = currentLang === 'hi' ? 'hi-IN' : 'en-IN';
        //         window.speechSynthesis.speak(u);
        //     }
        // }
    </script>
</body>

</html>