<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gate Access Control</title>
    <style>
        :root {
            --primary: #2563eb;
            --success: #059669;
            --success-bg: #d1fae5;
            --warning: #d97706;
            --warning-bg: #fef3c7;
            --bg: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #111827;
            --text-sub: #6b7280;
            --border: #e5e7eb;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            background: var(--bg);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- Header --- */
        .header {
            background: var(--card-bg);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
        }

        .brand {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
            padding: 6px 12px;
            border-radius: 20px;
            transition: all 0.3s;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .connected {
            background: var(--success-bg);
            color: var(--success);
        }

        .connected .status-dot {
            background: var(--success);
            box-shadow: 0 0 8px var(--success);
        }

        .disconnected {
            background: #fee2e2;
            color: #dc2626;
        }

        .disconnected .status-dot {
            background: #dc2626;
        }

        /* --- Main Layout --- */
        .main-container {
            display: grid;
            grid-template-columns: 350px 1fr 350px;
            /* Left List | Center Hero | Right List */
            gap: 20px;
            padding: 20px;
            flex: 1;
            overflow: hidden;
        }

        /* --- Columns (IN / OUT History) --- */
        .side-column {
            background: var(--card-bg);
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .column-header {
            padding: 15px;
            background: #f9fafb;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            color: var(--text-sub);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
        }

        .count-badge {
            background: var(--bg);
            padding: 2px 8px;
            border-radius: 4px;
            color: var(--text-main);
        }

        .list-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        /* --- List Items --- */
        .student-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 8px;
            transition: transform 0.2s;
        }

        .student-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .mini-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e5e7eb;
            margin-right: 12px;
            flex-shrink: 0;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .mini-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .item-details {
            flex: 1;
            overflow: hidden;
        }

        .item-name {
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .item-meta {
            font-size: 12px;
            color: var(--text-sub);
            display: flex;
            justify-content: space-between;
            margin-top: 2px;
        }

        /* --- Center Hero (Last Tapped) --- */
        .center-stage {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .hero-card {
            background: var(--card-bg);
            flex: 1;
            border-radius: 20px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 40px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
        }

        /* Visual flash effects */
        @keyframes flash-green {
            0% {
                background-color: var(--success-bg);
            }

            100% {
                background-color: var(--card-bg);
            }
        }

        @keyframes flash-orange {
            0% {
                background-color: var(--warning-bg);
            }

            100% {
                background-color: var(--card-bg);
            }
        }

        .animate-in {
            animation: flash-green 1s ease-out;
        }

        .animate-out {
            animation: flash-orange 1s ease-out;
        }

        .hero-image {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            background: #f3f4f6;
            margin-bottom: 24px;
            border: 4px solid #fff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 80px;
            color: #9ca3af;
        }

        .hero-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .hero-name {
            font-size: 32px;
            font-weight: 800;
            color: var(--text-main);
            margin-bottom: 8px;
        }

        .hero-id {
            font-size: 20px;
            color: var(--text-sub);
            background: #f3f4f6;
            padding: 4px 16px;
            border-radius: 20px;
        }

        .direction-badge {
            margin-top: 24px;
            padding: 10px 30px;
            border-radius: 30px;
            font-weight: 700;
            font-size: 18px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .dir-in {
            background: var(--success-bg);
            color: var(--success);
        }

        .dir-out {
            background: var(--warning-bg);
            color: var(--warning);
        }

        .dir-wait {
            background: #f3f4f6;
            color: #9ca3af;
        }

        /* --- Manual Entry Area --- */
        .manual-panel {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 16px;
            border: 1px solid var(--border);
        }

        .panel-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-sub);
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
        }

        .manual-form {
            display: flex;
            gap: 10px;
        }

        select,
        input {
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 15px;
            background: #f9fafb;
            outline: none;
            transition: border 0.2s;
        }

        select:focus,
        input:focus {
            border-color: var(--primary);
            background: #fff;
        }

        .input-group {
            display: flex;
            gap: 8px;
            flex: 1;
        }

        .input-roll {
            flex: 2;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .btn-manual {
            padding: 0 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .btn-in {
            background: var(--success);
            color: white;
        }

        .btn-out {
            background: var(--warning);
            color: white;
        }

        .btn-manual:hover {
            opacity: 0.9;
        }

        /* Settings Toggle */
        .settings-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            opacity: 0.5;
        }

        .settings-panel {
            display: none;
            position: fixed;
            top: 60px;
            right: 20px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border);
            z-index: 100;
            width: 300px;
        }

        .settings-panel.show {
            display: block;
        }

        .config-row {
            margin-bottom: 10px;
        }

        .config-row label {
            display: block;
            font-size: 12px;
            color: var(--text-sub);
            margin-bottom: 4px;
        }

        .config-row select {
            width: 100%;
        }

        /* Hide scrollbars for cleaner look */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }
    </style>
</head>

<body>

    <!-- Top Header -->
    <div class="header">
        <div class="brand">
            <span>üé´</span> NFC Gate Monitor
        </div>
        <div style="display:flex; align-items:center; gap:15px;">
            <div id="wsStatus" class="connection-status disconnected">
                <div class="status-dot"></div>
                <span>Connecting...</span>
            </div>
            <button class="settings-btn" onclick="toggleSettings()" title="Configure Readers">‚öôÔ∏è</button>
        </div>
    </div>

    <!-- Hidden Settings Panel (For Technicians Only) -->
    <div id="settingsPanel" class="settings-panel">
        <h3 style="margin-bottom:15px; font-size:16px;">Reader Configuration</h3>
        <div class="config-row">
            <label>Entry Reader (IN)</label>
            <select id="inReaderSelect" onchange="handleReaderChange('in')"></select>
        </div>
        <div class="config-row">
            <label>Exit Reader (OUT)</label>
            <select id="outReaderSelect" onchange="handleReaderChange('out')"></select>
        </div>
        <button onclick="refreshReaders()" style="width:100%; padding:8px; margin-top:10px; cursor:pointer;">Refresh
            Devices</button>
    </div>

    <div class="main-container">

        <!-- Left: Entry History -->
        <div class="side-column">
            <div class="column-header">
                <span>üì• Recent Entries</span>
                <span class="count-badge" id="countIn">0</span>
            </div>
            <div class="list-container" id="inList">
                <!-- Items injected here -->
            </div>
        </div>

        <!-- Center: Hero Card & Manual Entry -->
        <div class="center-stage">
            <!-- Hero Card -->
            <div class="hero-card" id="heroCard">
                <div class="hero-image" id="heroImg">üë§</div>
                <div class="hero-name" id="heroName">Waiting for tap...</div>
                <div class="hero-id" id="heroId">--</div>
                <div id="heroDirection" class="direction-badge dir-wait">Ready</div>
                <div style="position:absolute; bottom:15px; font-size:12px; color:#9ca3af;" id="heroTime">--:--:--</div>
            </div>

            <!-- Manual Entry Backup -->
            <div class="manual-panel">
                <div class="panel-title">
                    <span>‚å®Ô∏è Manual ID Entry</span>
                    <span style="font-weight:400; color:#9ca3af; font-size:12px;">Use if card fails</span>
                </div>
                <div class="manual-form">
                    <select id="manYear" style="width:80px;">
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                    </select>
                    <select id="manDept" style="width:90px;">
                        <option value="KUCP">KUCP</option>
                        <option value="KUEC">KUEC</option>
                        <option value="KUAD">KUAD</option>
                    </select>
                    <div class="input-group">
                        <input type="text" id="manRoll" class="input-roll" placeholder="Roll No." maxlength="4"
                            pattern="[0-9]*">
                    </div>
                    <button class="btn-manual btn-in" onclick="manualEntry('in')">IN</button>
                    <button class="btn-manual btn-out" onclick="manualEntry('out')">OUT</button>
                </div>
            </div>
        </div>

        <!-- Right: Exit History -->
        <div class="side-column">
            <div class="column-header">
                <span>üì§ Recent Exits</span>
                <span class="count-badge" id="countOut">0</span>
            </div>
            <div class="list-container" id="outList">
                <!-- Items injected here -->
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080';
        const WS_URL = 'ws://localhost:8080/ws';
        let ws = null;
        let reconnectInterval = null;
        let inCount = 0;
        let outCount = 0;
        let availableReaders = [];

        // Initialization
        document.addEventListener('DOMContentLoaded', () => {
            connectWebSocket();
            loadReaders(); // Load silently
            loadRecentEntries('in');
            loadRecentEntries('out');
        });

        // Settings Toggle
        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            panel.classList.toggle('show');
        }

        // WebSocket Connection
        function connectWebSocket() {
            const statusEl = document.getElementById('wsStatus');

            ws = new WebSocket(WS_URL);
            ws.onopen = () => {
                statusEl.className = 'connection-status connected';
                statusEl.innerHTML = '<div class="status-dot"></div><span>System Online</span>';
                if (reconnectInterval) clearInterval(reconnectInterval);
            };
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'tap') handleCardTap(data);
            };
            ws.onclose = () => {
                statusEl.className = 'connection-status disconnected';
                statusEl.innerHTML = '<div class="status-dot"></div><span>Reconnecting...</span>';
                if (!reconnectInterval) reconnectInterval = setInterval(connectWebSocket, 3000);
            };
        }

        // Core Logic: Handle a Tap
        function handleCardTap(data) {
            updateHeroCard(data);
            addStudentToList(data.direction, data);

            // Update counts
            if (data.status === 'success') {
                if (data.direction === 'in') { inCount++; document.getElementById('countIn').textContent = inCount; }
                if (data.direction === 'out') { outCount++; document.getElementById('countOut').textContent = outCount; }
            }
        }

        // Update the Big Center Card
        function updateHeroCard(data) {
            const card = document.getElementById('heroCard');
            const img = document.getElementById('heroImg');
            const name = document.getElementById('heroName');
            const id = document.getElementById('heroId');
            const dirBadge = document.getElementById('heroDirection');
            const time = document.getElementById('heroTime');

            // Reset Animations
            card.classList.remove('animate-in', 'animate-out');
            void card.offsetWidth; // Trigger reflow

            // Image
            if (data.image_path) {
                img.innerHTML = `<img src="${API_BASE}${data.image_path}" onerror="this.parentElement.innerHTML='üë§'">`;
            } else {
                img.innerHTML = 'üë§';
            }

            // Text Data
            name.textContent = data.name || 'Unknown User';
            id.textContent = data.student_id || 'ID Not Found';
            time.textContent = new Date(data.timestamp).toLocaleTimeString();

            // Styling based on IN/OUT
            if (data.direction === 'in') {
                dirBadge.textContent = 'ALLOWED ENTRY';
                dirBadge.className = 'direction-badge dir-in';
                card.classList.add('animate-in');
            } else {
                dirBadge.textContent = 'EXIT RECORDED';
                dirBadge.className = 'direction-badge dir-out';
                card.classList.add('animate-out');
            }
        }

        // Helper: Create List Item
        function createListItemHTML(student) {
            let imageHTML = '<div class="mini-avatar">üë§</div>';
            if (student.image_path) {
                imageHTML = `<div class="mini-avatar"><img src="${API_BASE}${student.image_path}" onerror="this.parentElement.innerHTML='üë§'"></div>`;
            }
            return `
            ${imageHTML}
            <div class="item-details">
                <div class="item-name">${student.name || 'Unknown'}</div>
                <div class="item-meta">
                    <span>${student.student_id || ''}</span>
                    <span class="time-stamp">${new Date(student.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                </div>
            </div>
        `;
        }

        // Add to Side Lists
        function addStudentToList(direction, student) {
            const listId = direction === 'in' ? 'inList' : 'outList';
            const list = document.getElementById(listId);
            const item = document.createElement('div');
            item.className = 'student-item';
            item.innerHTML = createListItemHTML(student);

            list.insertBefore(item, list.firstChild);
            // Keep list clean (max 20 items)
            while (list.children.length > 20) list.removeChild(list.lastChild);
        }

        // Fetch Initial Data
        async function loadRecentEntries(direction) {
            try {
                const response = await fetch(`${API_BASE}/api/entries/recent?direction=${direction}&limit=20`);
                const data = await response.json();
                const list = document.getElementById(direction === 'in' ? 'inList' : 'outList');
                list.innerHTML = '';

                // Update local count
                if (direction === 'in') { inCount = data.entries ? data.entries.length : 0; document.getElementById('countIn').textContent = inCount; }
                if (direction === 'out') { outCount = data.entries ? data.entries.length : 0; document.getElementById('countOut').textContent = outCount; }

                if (data.entries) {
                    data.entries.forEach(entry => {
                        const item = document.createElement('div');
                        item.className = 'student-item';
                        item.innerHTML = createListItemHTML(entry);
                        list.appendChild(item);
                    });
                }
            } catch (e) { console.error(e); }
        }

        // Manual Entry Logic
        async function manualEntry(direction) {
            const year = document.getElementById('manYear').value;
            const dept = document.getElementById('manDept').value;
            const roll = document.getElementById('manRoll').value;

            if (!roll || roll.length < 1) {
                alert('Please enter a Roll Number');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/entry/manual`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ year, department: dept, roll_number: roll, direction })
                });
                const data = await response.json();

                if (data.success) {
                    // Simulate a tap event locally for immediate feedback
                    handleCardTap({
                        direction: direction,
                        student_id: data.student_id,
                        name: data.name,
                        status: 'success',
                        image_path: null, // API should return this ideally
                        timestamp: new Date().toISOString()
                    });
                    document.getElementById('manRoll').value = ''; // Clear input
                } else {
                    alert('Error: ' + (data.error || 'Student not found'));
                }
            } catch (error) {
                alert('System Error: Could not process manual entry.');
            }
        }

        // --- Technical Configuration Functions ---
        async function loadReaders() {
            try {
                const response = await fetch(`${API_BASE}/api/readers`);
                const data = await response.json();

                // Store available readers globally
                availableReaders = data.readers.map(r => r.name);

                const inSelect = document.getElementById('inReaderSelect');
                const outSelect = document.getElementById('outReaderSelect');

                inSelect.innerHTML = '<option value="">Select Device...</option>';
                outSelect.innerHTML = '<option value="">Select Device...</option>';

                availableReaders.forEach(name => {
                    inSelect.add(new Option(name, name));
                    outSelect.add(new Option(name, name));
                });

                const configRes = await fetch(`${API_BASE}/api/readers/config`);
                const config = await configRes.json();
                if (config.in_reader) inSelect.value = config.in_reader;
                if (config.out_reader) outSelect.value = config.out_reader;
            } catch (e) { console.error(e); }
        }

        async function refreshReaders() {
            await fetch(`${API_BASE}/api/readers/refresh`, { method: 'POST' });
            loadReaders();
        }

        function handleReaderChange(changedRole) {
            const inSelect = document.getElementById('inReaderSelect');
            const outSelect = document.getElementById('outReaderSelect');

            const inVal = inSelect.value;
            const outVal = outSelect.value;

            // Auto-select logic
            if (changedRole === 'in' && inVal) {
                // If IN selected, and OUT is same or empty, try to find another
                if (outVal === inVal || !outVal) {
                    const other = availableReaders.find(r => r !== inVal);
                    if (other) {
                        outSelect.value = other;
                    } else {
                        // If no other reader, clear OUT to avoid duplicate
                        outSelect.value = "";
                    }
                }
            } else if (changedRole === 'out' && outVal) {
                // If OUT selected, and IN is same or empty, try to find another
                if (inVal === outVal || !inVal) {
                    const other = availableReaders.find(r => r !== outVal);
                    if (other) {
                        inSelect.value = other;
                    } else {
                        inSelect.value = "";
                    }
                }
            }

            // Final check to prevent duplicates if user manually forces it
            if (inSelect.value && outSelect.value && inSelect.value === outSelect.value) {
                if (changedRole === 'in') outSelect.value = "";
                else inSelect.value = "";
            }

            // Save
            fetch(`${API_BASE}/api/readers/config`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ in_reader: inSelect.value, out_reader: outSelect.value })
            });
        }
    </script>
</body>

</html>